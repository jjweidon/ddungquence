#!/bin/sh
# commit-msg: docs/12-git-conventions.md 기반 Conventional Commits 검증

commit_msg_file="$1"
first_line=$(head -n1 "$commit_msg_file")

# merge commit, revert 등은 통과
if echo "$first_line" | grep -qE '^(Merge|Revert|Initial commit)'; then
  exit 0
fi

# 형식: <type>(scope)?: <제목>
# type: feat, fix, docs, refactor, test, chore, perf
# scope: 선택, 영문/숫자/하이픈/언더스코어
if ! echo "$first_line" | grep -qE '^(feat|fix|docs|refactor|test|chore|perf)(\([a-zA-Z0-9_-]+\))?: .+'; then
  echo ""
  echo "❌ 커밋 메시지가 docs/12-git-conventions.md 규격을 따르지 않습니다."
  echo ""
  echo "형식: <type>(scope): <제목>"
  echo "예시:"
  echo "  feat(lobby): 방 생성 시 roomCodes 매핑 추가"
  echo "  fix(game): one-eyed jack 시퀀스 칩 제거 불가 처리"
  echo "  docs: Firebase 설정 가이드 추가"
  echo ""
  echo "type: feat, fix, docs, refactor, test, chore, perf"
  echo ""
  exit 1
fi

# 제목 길이: 72자 제한 (Git 권장)
subject=$(echo "$first_line" | sed -E 's/^[^:]+: //')
length=${#subject}
if [ "$length" -gt 72 ]; then
  echo ""
  echo "❌ 제목이 72자를 초과합니다 ($length자). 50자 내외 권장."
  echo ""
  exit 1
fi

# 변경량이 많으면 본문 필수 (수정 내용 많을 때 본문 작성 가이드)
files_changed=$(git diff --cached --name-only 2>/dev/null | wc -l | tr -d ' ')
lines_changed=$(git diff --cached --numstat 2>/dev/null | awk '{ add+=$1; del+=$2 } END { print add+del }')
if [ -z "$lines_changed" ]; then lines_changed=0; fi
if [ "$files_changed" -ge 5 ] || [ "$lines_changed" -ge 50 ]; then
  has_body=$(tail -n +2 "$commit_msg_file" | grep -q . && echo 1 || echo 0)
  if [ "$has_body" = "0" ]; then
    echo ""
    echo "❌ 변경 파일($files_changed개) 또는 변경 라인($lines_changed)이 많습니다. 본문을 작성해 주세요."
    echo ""
    echo "형식:"
    echo "  <type>(scope): <제목>"
    echo "  "
    echo "  - 변경 요약 1"
    echo "  - 변경 요약 2"
    echo ""
    exit 1
  fi
fi

# 터미널에서만: 커밋 메시지 검토 + 복사용 블록 (IDE/GUI에서는 스킵)
if [ -t 0 ]; then
  echo ""
  echo "--- 아래 메시지를 그대로 복사해 사용할 수 있습니다 ---"
  cat "$commit_msg_file"
  echo "---"
  echo ""
  printf "검토 후 Enter로 진행, Ctrl+C로 취소: "
  read -r _
fi

exit 0
