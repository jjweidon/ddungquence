---
description: USE WHEN setting up Firebase client/auth or adding firebase initialization files. Enforce NEXT_PUBLIC env-only and cost guardrails.
globs: src/lib/firebase/**/*.ts,src/lib/firebase/**/*.tsx,src/features/auth/**/*.ts,src/features/auth/**/*.tsx
alwaysApply: false
---
# Firebase 설정(Next.js 클라이언트)

## 환경변수(로컬/배포 공통)
`.env.local` 및 Vercel Env에 동일하게 설정:
```bash
NEXT_PUBLIC_FIREBASE_API_KEY=...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=...
NEXT_PUBLIC_FIREBASE_PROJECT_ID=...
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=...
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=...
NEXT_PUBLIC_FIREBASE_APP_ID=...
```

## Firebase 초기화(권장 위치)
- `src/lib/firebase/client.ts`
```ts
import { initializeApp, getApps } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY!,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN!,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID!,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET!,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID!,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID!,
};

export const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = getFirestore(app);
```

## Google 로그인(클라이언트, uid 확보)
- `src/features/auth/ensureAuth.ts`
```ts
import { signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "firebase/auth";
import { auth } from "@/lib/firebase/client";

export function ensureAuth(): Promise<string> {
  return new Promise((resolve, reject) => {
    const unsub = onAuthStateChanged(auth, async (user) => {
      try {
        if (user?.uid) {
          unsub();
          resolve(user.uid);
          return;
        }
        const provider = new GoogleAuthProvider();
        const cred = await signInWithPopup(auth, provider);
        unsub();
        resolve(cred.user.uid);
      } catch (e) {
        unsub();
        reject(e);
      }
    });
  });
}
```

## 무료 구간 최적화 팁(필수)
- onSnapshot 남발 금지: public 1 + private 1 고정
- presence(lastSeenAt) 업데이트는 저빈도(30~60초 수준)
- 이벤트 로그는 디버깅 때만 옵션으로 켠다
