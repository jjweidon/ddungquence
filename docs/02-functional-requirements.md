# 02. 기능적 요구사항(FR)

## 0) 우선순위 표기
- P0: MVP 필수
- P1: 있으면 좋음(2차)
- P2: 고급/확장

---

## 1) 계정/세션

### FR-1 Google 로그인(P0)
- 사용자는 앱 접속 시 Firebase Auth **Google 로그인**으로 uid를 발급받는다.
- 닉네임은 Google 프로필 또는 로컬 저장 + 방 입장 시 public 프로필로 반영.

**수용 기준**
- [ ] 새로고침해도 uid는 유지(동일 브라우저 기준)
- [ ] 닉네임 미입력 시 Google displayName 또는 자동 닉네임(예: Player-AB12)

### FR-2 프로필 관리(P1)
- 닉네임 변경, 아바타(색/아이콘) 선택

---

## 2) 로비/방

### FR-3 방 생성(P0)
- “새 방 만들기” 버튼으로 방 생성
- 방 코드는 짧은 문자열(예: 6자리 Base32)로 생성
- 생성자는 host로 지정

**수용 기준**
- [ ] 방 생성 후 즉시 로비 화면으로 이동
- [ ] 방 코드를 공유할 수 있다(복사 버튼)

### FR-4 방 참가(P0)
- 방 코드를 입력하여 참가
- 방이 존재하지 않거나 입장 불가 조건이면 에러 표시
- **관전 정책**: 참가 가능 자리가 없으면(방이 꽉 찬 경우) **자동으로 관전 모드**로 입장. 단, **관전 인원도 최대(2명)에 도달**했으면 입장 불가.
- **게임 진행 중**: 신규 관전 입장 불가(퇴장만 가능).

**수용 기준**
- [ ] 잘못된 코드: “방을 찾을 수 없음”
- [ ] 참가 자리 없음 + 관전 자리 있음 → 관전으로 입장
- [ ] 참가 자리 없음 + 관전 2명 이미 찼음 → “입장 불가” 표시
- [ ] 게임 진행 중 코드 입력 시: “게임 진행중인 방입니다” 등 안내

### FR-4.1 관전 모드 정책(P0)
- **최대 관전 인원: 2명**으로 제한.
- **입장 시**: 참가 자리가 없으면 자동 관전; 관전 2명이면 입장 불가.
- **게임 시작 전(로비)**:
  - **참여자**는 “관전하기” 버튼으로 **관전 모드 전환** 가능.
  - **관전자**는 방에 **참여 자리가 남아 있으면** “참여하기”로 **참여자 전환** 가능.
- **게임 시작 후**:
  - **관전자 신규 입장 불가.** 이미 있는 관전자는 **퇴장만 가능**(퇴장 버튼 제공).
  - **게임 참여자(플레이어)는 퇴장 버튼 없음.** 네트워크 끊김/접속 종료 시에만 **자동 퇴장** 처리.

**수용 기준**
- [ ] 로비에서 참여자 → 관전 전환 시 목록에서 관전자 구역으로 이동
- [ ] 로비에서 관전자 → 참여 전환 시 팀/Ready 설정 가능
- [ ] 게임 중 관전자만 “퇴장” 버튼 노출; 참여자에게는 퇴장 버튼 미노출
- [ ] 참여자 연결 끊김 시 자동 퇴장(타임아웃/ presence 정책)

### FR-5 로비 상태 관리(P0)
- 로비에서 **참여자** 목록, 팀 배정, Ready 상태를 표시. **관전자** 목록은 별도 구역 또는 구분 표시(최대 2명).
- host만 “게임 시작” 가능

**수용 기준**
- [ ] 모든 플레이어(참여자) Ready일 때만 게임 시작 활성화(정책 선택 가능)
- [ ] 참여자/관전자가 나가면 로비가 자동 갱신
- [ ] 관전자 수가 2명 이하로 유지되는지 검증

### FR-6 팀 배정(P0)
- MVP: 2팀(A/B) 지원
- **팀 색상**: 레드 · 블루 · 그린. **배정 순서**: 처음 배정되는 팀 = **레드**, 다음 팀 = **블루**, 그 다음 = **그린**(1번 팀 레드, 2번 팀 블루, 3번 팀 그린).
- 팀 내 Seat 순서가 턴 순서에 영향(Seat = 플레이 순서)

**수용 기준**
- [ ] 팀 인원 밸런스 제한(예: 2v2, 1v1 허용)
- [ ] 팀 변경은 로비에서만 가능
- [ ] 팀별 칩/UI 색상이 배정 순서(레드→블루→그린)와 일치

### FR-7 재접속/복원(P0)
- 네트워크 끊김/새로고침 후 같은 uid로 복원되면 로비/게임 상태 자동 복귀

---

## 3) 게임 진행(턴 기반)

### FR-8 게임 시작(P0)
- host가 게임 시작 시:
  - 덱 셔플/딜링
  - 보드 초기화
  - 첫 턴 플레이어 결정(간단 규칙: host 왼쪽 = Seat0 또는 랜덤)

**수용 기준**
- [ ] 시작 후 모든 클라이언트가 동일한 초기 상태를 렌더링
- [ ] 손패는 본인만 열람 가능(타인 노출 없음)

### FR-9 손패 UI/행동(P0)
- 본인 손패를 카드 형태로 표시
- 카드 클릭 → “사용(Discard)” → 가능한 보드 칸 하이라이트

**수용 기준**
- [ ] 내 턴이 아니면 손패는 선택 불가(읽기만)
- [ ] 카드 선택 시 가능한 칸만 인터랙션 가능

### FR-10 일반 카드 플레이(P0)
- 카드 1장 discard(공개)
- 대응하는 보드 칸 중 비어있는 곳을 선택하여 칩 배치
- 자동 드로우 1장

**수용 기준**
- [ ] 해당 카드 보드 칸이 2개라면 둘 중 선택 가능
- [ ] 두 칸이 모두 점유이면 “데드 카드”로 분류(별도 FR)

### FR-11 잭(2-eye) 플레이(P0)
- 2-eye 잭 discard(공개)
- 어떤 빈 칸에도 칩 1개 배치(변형 규칙: 코너도 일반 칸과 동일하게 빈 칸이면 배치 가능)

**수용 기준**
- [ ] 빈 칸만 선택 가능
- [ ] 배치 후 자동 드로우

### FR-12 잭(1-eye) 플레이(P0)
- 1-eye 잭 discard(공개)
- 상대 칩 1개 제거
- 변형 규칙: 제거한 칸에 **바로 다음 플레이어만** two-eyed jack 사용 불가. 그 다음 순서부터는 two-eyed jack으로 그 칸 배치 가능.
- 완성된 시퀀스에 포함된 칩은 제거 불가(MVP)

**수용 기준**
- [ ] 제거 가능 칩만 하이라이트
- [ ] 제거 후 자동 드로우(정책: 제거도 “턴 소비”이므로 드로우 수행)
- [ ] 바로 다음 턴 플레이어는 제거된 칸에 two-eyed jack 사용 불가

### FR-13 데드 카드(P0, 변형 규칙)
- 데드 카드(두 칸 모두 점유된 카드)는 **교체하지 않고** 손에 유지하며, 해당 카드는 사용할 수 없는 카드로만 취급한다.

**수용 기준**
- [ ] 데드 카드 판정 시 사용 불가 표시(또는 비활성화)
- [ ] 데드 카드로는 플레이/버리기/교체 드로우를 할 수 없음

### FR-14 시퀀스 판정(P0)
- 매 턴 결과로 보드에 새 칩/제거가 발생하면 시퀀스 판정을 수행
- 2팀 모드: 2시퀀스 달성 시 즉시 종료

**수용 기준**
- [ ] 가로/세로/대각 5연속만 인정
- [ ] 변형 규칙: 코너도 카드로 칩을 놓으므로 5칸 필요, 코너 칸은 팀 전용(공유 불가)
- [ ] 2시퀀스 모드에서는 기존 시퀀스와 두 번째 시퀀스가 1칸 중복 가능

### FR-15 턴 관리(P0)
- 현재 턴 플레이어, 제한 시간(선택), 다음 플레이어 계산

**수용 기준**
- [ ] 내 턴이면 UI 상단/보드에 강한 표시
- [ ] 트랜잭션 충돌 시(중복 제출) 사용자에게 안전하게 롤백 표시

### FR-16 게임 종료/재시작(P1)
- 승리 팀/플레이어 표시, 결과 화면
- 변형 규칙: 덱이 모두 소진될 때까지 승부가 나지 않으면 **무승부**로 종료(리셔플 없음)
- 동일 멤버로 “리매치” 버튼(방 유지)

---

## 4) 동기화/실시간

### FR-17 실시간 보드 동기화(P0)
- Room의 public game state를 실시간 구독
- 변경이 오면 UI에 즉시 반영(애니메이션/하이라이트)

### FR-18 비공개 손패 동기화(P0)
- 각 플레이어의 hand는 **private 문서**로 저장하고, 본인만 구독/열람

### FR-19 이벤트 로그(선택)(P1)
- 최근 N턴 로그(누가 어떤 카드를 버렸는지, 어떤 칸에 놓았는지)
- 디버깅 및 재접속 복원에 도움

---

## 5) 관리/운영(최소)

### FR-20 방 정리(P1)
- 일정 시간 비활성 방 자동 정리(서버/함수 없이 하려면 클라이언트 기반으로만 처리 가능)
- MVP: 수동 종료/방 나가기 중심

---

## 6) MVP 스코프 고정(명시)
MVP에 포함:
- 리플레이/관전/랭킹

MVP에서 제외:
- 채팅
- 매치메이킹(랜덤 매칭)
- 초대 링크 딥링크
- 3팀/대규모 인원
- 치트 완전 방지(친구방 신뢰 모델)

---

## 7) DoD 체크리스트
- [ ] 방 생성/참가/Ready/시작이 end-to-end로 동작
- [ ] 내 턴에만 액션 가능, 타 턴에는 불가
- [ ] 잭/데드 카드 포함 규칙이 정상 동작
- [ ] 손패 비공개가 보장된다(다른 uid로 읽기 불가)
